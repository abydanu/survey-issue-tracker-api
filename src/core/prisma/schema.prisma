// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String    @id @default(cuid())
  username    String    @unique
  email       String?   @unique
  password    String
  name        String
  role        Role      @default(USER)
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  passwordResetOtps PasswordResetOtp[]

  @@map("users")
}

enum Role {
  ADMIN
  USER
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sessions")
}

model PasswordResetOtp {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  otp       String
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  attempts  Int      @default(0) @map("attempts")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([otp])
  @@index([userId])
  @@map("password_reset_otps")
}

model SyncLog {
  id        String   @id @default(cuid())
  status    Status
  message   String?
  sheetName String?  @map("sheet_name")
  syncedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sync_logs")
}

model EnumValue {
  id          String   @id @default(cuid())
  enumType    String   @map("enum_type")
  value       String
  displayName String?  @map("display_name")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  jenisKendalaRecords    NewBgesB2BOlo[] @relation("JenisKendala")
  planTematikRecords     NewBgesB2BOlo[] @relation("PlanTematik")
  statusUsulanRecords    NewBgesB2BOlo[] @relation("StatusUsulan")
  statusInstalasiRecords NewBgesB2BOlo[] @relation("StatusInstalasi")
  keteranganRecords      NewBgesB2BOlo[] @relation("Keterangan")

  statusJtRecords           NdeUsulanB2B[] @relation("StatusJt")
  statusInstalasiNdeRecords NdeUsulanB2B[] @relation("StatusInstalasiNde")

  @@unique([enumType, value])
  @@index([enumType])
  @@index([isActive])
  @@map("enum_values")
}

enum Status {
  SUCCESS
  FAILED
}

enum SyncStatus {
  SYNCED
  PENDING
  CONFLICT
  ERROR
}

model NewBgesB2BOlo {
  id             String    @id @default(cuid())
  umur           Int?
  bln            String?
  tglInputUsulan DateTime? @map("tgl_input_usulan")
  idKendala      String    @unique @map("id_kendala")
  jenisOrder     String?   @map("jenis_order")

  datel         String?
  sto           String?
  namaPelanggan String? @map("nama_pelanggan")
  latitude      String?
  longitude     String?

  jenisKendalaId String? @map("jenis_kendala_id")
  planTematikId  String? @map("plan_tematik_id")

  rabHld    Decimal? @map("rab_hld") @db.Decimal(15, 0)
  ihldValue BigInt?  @map("ihld_value") @db.BigInt

  statusUsulanId    String? @map("status_usulan_id")
  statusIhld        String? @map("status_ihld")
  idEprop           String? @map("id_eprop")
  statusInstalasiId String? @map("status_instalasi_id")
  keteranganId      String? @map("keterangan_id")
  newSc             String? @map("new_sc")

  namaOdp   String?   @map("nama_odp")
  tglGolive DateTime? @map("tgl_golive")

  avai          Int?
  used          Int?
  isTotal       Int?     @map("is_total")
  occPercentage Decimal? @map("occ_percentage") @db.Decimal(5, 2)

  jenisKendala    EnumValue? @relation("JenisKendala", fields: [jenisKendalaId], references: [id])
  planTematik     EnumValue? @relation("PlanTematik", fields: [planTematikId], references: [id])
  statusUsulan    EnumValue? @relation("StatusUsulan", fields: [statusUsulanId], references: [id])
  statusInstalasi EnumValue? @relation("StatusInstalasi", fields: [statusInstalasiId], references: [id])
  keterangan      EnumValue? @relation("Keterangan", fields: [keteranganId], references: [id])

  ndeUsulan NdeUsulanB2B?

  syncStatus     SyncStatus @default(SYNCED) @map("sync_status")
  lastSyncAt     DateTime?  @map("last_sync_at")
  sheetRowNumber Int?       @map("sheet_row_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([idKendala])
  @@index([bln])
  @@index([tglInputUsulan])
  @@index([datel])
  @@index([sto])
  @@index([statusUsulanId])
  @@index([statusInstalasiId])
  @@map("new_bges_b2b_olo")
}

model NdeUsulanB2B {
  id String @id @default(cuid())

  no       String @unique
  nomorNcx String @unique @map("nomor_ncx")

  statusJtId      String?  @map("status_jt_id")
  c2r             Decimal? @db.Decimal(10, 2)
  alamatInstalasi String?  @map("alamat_instalasi") @db.Text
  jenisLayanan    String?  @map("jenis_layanan")
  nilaiKontrak    Decimal? @map("nilai_kontrak") @db.Decimal(15, 0)
  rabSurvey       Decimal? @map("rab_survey") @db.Decimal(15, 0)
  nomorNde        String?  @map("nomor_nde")
  progressJt      String?  @map("progress_jt")
  namaOdp         String?  @map("nama_odp")
  jarakOdp        Decimal? @map("jarak_odp") @db.Decimal(10, 2)
  keterangan      String?  @db.Text

  datel             String?
  sto               String?
  namaPelanggan     String?  @map("nama_pelanggan")
  latitude          String?
  longitude         String?
  ihldLopId         Int?     @map("ihld_lop_id")
  planTematik       String?  @map("plan_tematik")
  rabHld            Decimal? @map("rab_hld") @db.Decimal(15, 0)
  statusUsulan      String?  @map("status_usulan")
  statusInstalasiId String?  @map("status_instalasi_id")

  statusJt        EnumValue? @relation("StatusJt", fields: [statusJtId], references: [id])
  statusInstalasi EnumValue? @relation("StatusInstalasiNde", fields: [statusInstalasiId], references: [id])

  masterData NewBgesB2BOlo? @relation(fields: [nomorNcx], references: [idKendala])

  syncStatus     SyncStatus @default(SYNCED) @map("sync_status")
  lastSyncAt     DateTime?  @map("last_sync_at")
  sheetRowNumber Int?       @map("sheet_row_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([no])
  @@index([nomorNcx])
  @@index([datel])
  @@index([sto])
  @@index([syncStatus])
  @@map("nde_usulan_b2b")
}
